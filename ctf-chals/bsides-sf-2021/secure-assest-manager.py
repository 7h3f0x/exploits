#!/usr/bin/env python
from pwn import *

context.log_level = "debug"

p = remote('secure-asset-manager-4235c8a4.challenges.bsidessf.net', 6112)

# p.recv('"\x00')
# p.recv("secure-asset-manager server v1.0")

def send(data):
    assert len(data) <= 0xffff
    p.send(p16((len(data))))
    p.send(data)

def recv():
    length = u16(p.recv(2))
    data = p.recv(length)
    print(hexdump(data))
    return length, data

print("Connected to %s:%d" % ("secure-asset-manager-4235c8a4.challenges.bsidessf.net", 6112))

_, version = recv()

print("Server version: %s" % (version,))

send("secure-asset-manager client v1.00\x00")

length, challenge = recv()

print("Received server challenge (%ld bytes), calculating response" % (length))

with open("./a.bin", "wb") as f:
    f.write(challenge)

result = int(subprocess.check_output('./solve'))

send(p32(result))

_, did_pass = recv()

assert did_pass == "PASS"

send("CHECK_UPDATES")

_, updates = recv()

assert updates[0] == '0'

send("I_AM thebunker")


# send("HELP")
# send("FLAG")


while True:
    _, data = recv()
    print(data)
    send(raw_input("> "))

p.interactive()
